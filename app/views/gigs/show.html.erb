<div class="container">
  <div class="row">
    <div class="col-md-8">
      <h1>
        <strong><%= @gig.title %></strong>
      </h1>
      <ol class="breadcrumb">
        <li>
          CREATED <%= distance_of_time_in_words_to_now(@gig.created_at).upcase %> AGO, IN 
          <%= link_to Category.find(@gig.category_id).title.upcase, search_by_category_path(category_url: @gig.category.category_url), :class=>"go_green" %> / 
          <%= link_to Category.find(@gig.category_id).subtitle.upcase, search_by_subcategory_path(category_url: @gig.category.category_url, subcategory_url: @gig.category.subcategory_url) , :class=>"go_green" %>
        </li>
        <li> <%= social_share_button_tag(@gig.title, :url => request.original_url) %></li>
        
      </ol>



      <ul class="bxslider">
       <% @slide.each do |image,index| %>
          <% if !image.try(:image).nil?%>
           <%= image_tag (image.image.url),:class=>"img" %>
          <% else %>
            <% youtube_id = image.video_url.split("=")[1] %>
            <iframe title="YouTube video player" width="480" height="460" src="http://www.youtube.com/embed/<%= youtube_id %>?controls=2" frameborder="0" allowfullscreen></iframe>
          <% end %>
        <% end %>
      </ul>

      <p>
        <%= @gig.description %>
      </p>

      <% if !@gig.extragigs.blank? %>
        <p>
          <%= form_tag purchase_gig_path, :id=>"purchase_gig_form" do %>
            <ul class="list-group">
              <li class="list-group-item">
                <span class="right"><%= select_tag "quantity", options_for_select(options_for_select(1..20)), :class =>"quantity form-control" %></span>
                 <h2> Check out my Gig Extras</h2>
              </li>
              <% @gig.extragigs.each do |extragig| %>
                <li class="list-group-item">
                  <span class="right"><%= select_tag "extraquantity[]", options_for_select((1..20).map{|n| [n.to_s+" ($"+((extragig.amount)*n).to_s+")", n.to_s+"_"+extragig.amount.to_s+"_"+extragig.id.to_s] }) , :id=>"extraquantity_#{extragig.id}_#{extragig.amount}", :class=>"quantity form-control", :style=>"margin-top:-5px" %></span>
                  <%= check_box_tag 'extragig[]', extragig.id, false, :id=>"checkbox_#{extragig.id}", :class=>"extra_checkbox" %>
                  <%= extragig.title %>
                </li>
              <% end %>
            </ul>
            <%= submit_tag "Order Now($5)", :class=> "btn btn-success right order_link", :name=>"5" if @gig.user != current_user %>
          <% end %>
        </p>
      <% end %>

    </div>

    <div class="col-md-4">
      <% if @gig.extragigs.blank? %>
        <%= form_tag purchase_gig_path, :id=>"purchase_gig_form" do %>
          <span style="float:left"><%= select_tag "quantity", options_for_select(options_for_select(1..20)), :class =>"quantity form-control" %></span>
        <% end %>&nbsp;&nbsp;&nbsp;
      <% end %>
      <%= link_to "Order Now($5)", "#", :class=> "btn btn-lg btn-success order_gig order_link", :style=>"color:white" if @gig.user != current_user %>
      <hr>
      <div id="user_star"></div>

      <hr>
      <% if @gig.express_boolean %>
        <b>Delivered within 24 hours</b>
      <% end %>
      <hr>
      <p>
        <%= image_tag @gig.user.avatar.url, :style=>"width:50px" %>
        <strong>By:</strong>
        <b style="font-size: x-large;"><%=link_to @gig.user.name, profile_path(username: @gig.user.username ), :method=>"post", :class=>"go_green" %><br/> </b>
          <span style="font-size: smaller; font-weight: 100;" >
          <% if !@gig.user.location.nil? %>FROM: <%= @gig.user.location %><br/> <% end %>
           JOINED OVER <%= distance_of_time_in_words_to_now(@gig.user.created_at).upcase %> AGO 
         </span>
      </p>
      <hr>

      <%= link_to "CONTACT ME", conversation_path(@gig.user), :class=>"go_green" %>
      <hr>

      <p>
        <strong>Related Topics:</strong>
        <ul class="tag_list">
          <% @gig.tag_list.each do |tag| %>
            <li><a href="#"><%= tag %></a></li>
          <% end %>
        </ul>
      </p>


      <% if @gig.user == current_user %>
        <%= link_to 'Edit', edit_gig_path(@gig), :class=>"btn btn-default" %>
        <%= link_to "Create Extragig", new_gig_extragig_path(@gig), :class=>"btn btn-default" %>
      <% end %>
      
    </div>
  </div>
</div>

<script>
  $(function(){
    raty_js()
    <% if @user_gig_transaction.present? && current_user.ratings.where(gig_id: @gig.id, score: 0).present? %>
      $('#user_star').raty({
        score: <%= @rating.score %>,
        path: '/assets',
        click: function(score, evt) {
          $.ajax({
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            url: '/ratings/' + <%= @rating.id %>,
            type: 'PATCH',
            data: { score: score }
          });
        }
      });
    <% else %>
      $('#user_star').raty({
        score: <%= @avg_rate %>,
        path: '/assets',
        readOnly: true
      });
    <% end %>
  })

  $(document).ready(function(){
    $('.bxslider').bxSlider({
      adaptiveHeight: true,
      infiniteLoop: false,
      hideControlOnEnd: true
    });

    $("#quantity").change(function(){
      var value = ($(this).val() *5 )
      $(".order_link").val('Order Now($'+(value)+')')
      $(".order_link").text('Order Now($'+(value)+')')
    })


    $(".quantity").change(function(){
      extragig_id = this.id.split("_")[1]
      
      $("#checkbox_"+extragig_id).prop('checked', true);

      $.each($('.quantity'), function(index, value){
        var gig_id = $(value).attr("id")
        var gig_value = $(value).val()
        if (gig_id == "quantity") {
          amount = (gig_value*5)
        }
        else{
          if ($("#checkbox_"+gig_id.split("_")[1]).is(':checked')) {
            amount += ((gig_value.split("_")[0]) * (gig_value.split("_")[1]) )
          }
        }
      });
      $(".order_link").val('Order Now($'+(amount)+')')
      $(".order_link").text('Order Now($'+(amount)+')')
    })

    $(".extra_checkbox").change(function(){
      if ($(this).is(':checked')) {
        $.each($('.quantity'), function(index, value){
          var gig_id = $(value).attr("id")
          var gig_value = $(value).val()
          if (gig_id == "quantity") {
            amount = (gig_value*5)
          }
          else{
            if ($("#checkbox_"+gig_id.split("_")[1]).is(':checked')) {
              amount += ((gig_value.split("_")[0]) * (gig_value.split("_")[1]) )
            }
          }
        });
      }
      else{
        $.each($('.quantity'), function(index, value){
          var gig_id = $(value).attr("id")
          var gig_value = $(value).val()
          if (gig_id == "quantity") {
            amount = (gig_value*5)
          }
          else{
            if ($("#checkbox_"+gig_id.split("_")[1]).is(':checked')) {
              amount += ((gig_value.split("_")[0]) * (gig_value.split("_")[1]) )
            }
          }
        });
      }
      $(".order_link").val('Order Now($'+(amount)+')')
      $(".order_link").text('Order Now($'+(amount)+')')
    })

    $(".order_gig").click(function(){
      $("#purchase_gig_form").submit()
    })
  });
</script>


<style>
  .embedly-embed{height: 460px !important;}
  .bx-viewport{ height:470px !important; }


  .bx-wrapper, .bx-viewport img{
    height: 458px !important; /*provide height of slider*/
}

.right{
  float: right;
}

ul.tag_list li{
  background: none repeat scroll 0 0 #ccc;
  border-radius: 3px;
  display: inline-block;
  margin: 5px 5px 0 0;
  padding: 3px 6px; 
}

ul.tag_list li a{
  color: #fff;
}

ul.tag_list li:hover{
  background-color: #00B22D;
  color: #fff;
}

</style>